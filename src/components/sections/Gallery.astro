---
import { Image } from 'astro:assets';
import { gallery } from '../../data/content';
import Section from '../layout/Section.astro';
import Heading from '../ui/Heading.astro';
import FadeIn from '../animation/FadeIn.astro';

// Import gallery images for optimization
import gallery01 from '../../assets/gallery/01.jpg';
import gallery02 from '../../assets/gallery/02.jpg';
import gallery03 from '../../assets/gallery/03.jpg';
import gallery04 from '../../assets/gallery/04.jpg';
import gallery05 from '../../assets/gallery/05.jpg';
import gallery06 from '../../assets/gallery/06.jpg';
import gallery07 from '../../assets/gallery/07.jpg';
import gallery08 from '../../assets/gallery/08.jpg';
import gallery09 from '../../assets/gallery/09.jpg';

const galleryImages = [
  { src: gallery01, alt: gallery.images[0].alt },
  { src: gallery02, alt: gallery.images[1].alt },
  { src: gallery03, alt: gallery.images[2].alt },
  { src: gallery04, alt: gallery.images[3].alt },
  { src: gallery05, alt: gallery.images[4].alt },
  { src: gallery06, alt: gallery.images[5].alt },
  { src: gallery07, alt: gallery.images[6].alt },
  { src: gallery08, alt: gallery.images[7].alt },
  { src: gallery09, alt: gallery.images[8].alt },
];
---

<Section id="gallery" variant="default" padding="xl" bgColor="rojo-oscuro">
  <div class="max-w-6xl mx-auto">
    <FadeIn>
      <Heading level={2} size="h2" class="text-center mb-16">
        {gallery.title}
      </Heading>
    </FadeIn>

    <!-- Masonry Gallery -->
    <div class="gallery-masonry columns-2 md:columns-3 gap-4">
      {galleryImages.map((image, index) => (
        <FadeIn delay={0.05 * (index + 1)} direction="up">
          <button
            type="button"
            class="gallery-item group relative overflow-hidden rounded-xl bg-surface cursor-pointer w-full mb-4 break-inside-avoid"
            data-image-index={index}
            data-image-src={image.src.src}
            data-image-alt={image.alt}
            aria-label={`Ver imagen: ${image.alt}`}
          >
            <!-- Optimized gallery image -->
            <Image
              src={image.src}
              alt={image.alt}
              widths={[600, 1200, 1800]}
              sizes="(max-width: 768px) 50vw, 33vw"
              quality={95}
              format="webp"
              class="w-full h-auto rounded-xl"
              loading="lazy"
            />

            <!-- Hover overlay -->
            <div class="absolute inset-0 bg-primary/10 group-hover:bg-primary/25 transition-colors duration-300 rounded-xl"></div>

            <!-- Zoom icon on hover -->
            <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity duration-300">
              <div class="w-12 h-12 rounded-full bg-background/80 flex items-center justify-center">
                <svg class="w-5 h-5 text-text" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7" />
                </svg>
              </div>
            </div>
          </button>
        </FadeIn>
      ))}
    </div>
  </div>
</Section>

<!-- Lightbox Modal -->
<div id="lightbox" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/95 backdrop-blur-sm">
  <!-- Close button -->
  <button
    id="lightbox-close"
    class="absolute top-4 right-4 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"
    aria-label="Cerrar"
  >
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
    </svg>
  </button>

  <!-- Navigation arrows -->
  <button
    id="lightbox-prev"
    class="absolute left-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"
    aria-label="Anterior"
  >
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
    </svg>
  </button>

  <button
    id="lightbox-next"
    class="absolute right-4 top-1/2 -translate-y-1/2 z-10 w-12 h-12 rounded-full bg-white/10 hover:bg-white/20 flex items-center justify-center transition-colors"
    aria-label="Siguiente"
  >
    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
    </svg>
  </button>

  <!-- Image container -->
  <div class="max-w-[90vw] max-h-[90vh] flex items-center justify-center">
    <img
      id="lightbox-image"
      src=""
      alt=""
      class="max-w-full max-h-[90vh] object-contain rounded-lg"
    />
  </div>
</div>

<script>
  import { gsap } from '../../scripts/gsap';

  function initGallery() {
    const prefersReducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const items = document.querySelectorAll('.gallery-item') as NodeListOf<HTMLElement>;
    const lightbox = document.getElementById('lightbox');
    const lightboxImage = document.getElementById('lightbox-image') as HTMLImageElement;
    const lightboxClose = document.getElementById('lightbox-close');
    const lightboxPrev = document.getElementById('lightbox-prev');
    const lightboxNext = document.getElementById('lightbox-next');

    let currentIndex = 0;
    const imageData: { src: string; alt: string }[] = [];

    // Collect image data
    items.forEach((item) => {
      imageData.push({
        src: item.dataset.imageSrc || '',
        alt: item.dataset.imageAlt || '',
      });
    });

    // Open lightbox
    function openLightbox(index: number) {
      currentIndex = index;
      updateLightboxImage();
      lightbox?.classList.remove('hidden');
      lightbox?.classList.add('flex');
      document.body.style.overflow = 'hidden';
    }

    // Close lightbox
    function closeLightbox() {
      lightbox?.classList.add('hidden');
      lightbox?.classList.remove('flex');
      document.body.style.overflow = '';
    }

    // Update lightbox image
    function updateLightboxImage() {
      if (lightboxImage && imageData[currentIndex]) {
        lightboxImage.src = imageData[currentIndex].src;
        lightboxImage.alt = imageData[currentIndex].alt;
      }
    }

    // Navigate to previous image
    function prevImage() {
      currentIndex = (currentIndex - 1 + imageData.length) % imageData.length;
      updateLightboxImage();
    }

    // Navigate to next image
    function nextImage() {
      currentIndex = (currentIndex + 1) % imageData.length;
      updateLightboxImage();
    }

    // Event listeners for gallery items
    items.forEach((item, index) => {
      item.addEventListener('click', () => openLightbox(index));

      if (prefersReducedMotion) return;

      item.addEventListener('mouseenter', () => {
        gsap.to(item, {
          scale: 1.02,
          duration: 0.3,
          ease: 'power2.out',
        });
      });

      item.addEventListener('mouseleave', () => {
        gsap.to(item, {
          scale: 1,
          duration: 0.3,
          ease: 'power2.out',
        });
      });
    });

    // Lightbox controls
    lightboxClose?.addEventListener('click', closeLightbox);
    lightboxPrev?.addEventListener('click', prevImage);
    lightboxNext?.addEventListener('click', nextImage);

    // Close on backdrop click
    lightbox?.addEventListener('click', (e) => {
      if (e.target === lightbox) closeLightbox();
    });

    // Keyboard navigation
    document.addEventListener('keydown', (e) => {
      if (lightbox?.classList.contains('hidden')) return;
      if (e.key === 'Escape') closeLightbox();
      if (e.key === 'ArrowLeft') prevImage();
      if (e.key === 'ArrowRight') nextImage();
    });
  }

  initGallery();
  document.addEventListener('astro:page-load', initGallery);
</script>
